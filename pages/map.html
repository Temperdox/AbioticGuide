<div class="container-fluid mt-4">

  <div class="row">
    <div class="col-lg-3 mb-3">
      <div class="map-controls">
        <h5><i class="fas fa-map-marked-alt"></i> Map Selection</h5>
        <select id="mapSelector" class="form-select map-selector mb-3">
          <option value="">Loading maps...</option>
        </select>
        <hr>
        <h5><i class="fas fa-filter"></i> Filters</h5>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="showItems" checked>
          <label class="form-check-label" for="showItems">
            <i class="fas fa-box"></i> Items & Resources
          </label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="showEnemies" checked>
          <label class="form-check-label" for="showEnemies">
            <i class="fas fa-skull-crossbones"></i> Enemies
          </label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="showLocations" checked>
          <label class="form-check-label" for="showLocations">
            <i class="fas fa-map-pin"></i> Key Locations
          </label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="showNPCs" checked>
          <label class="form-check-label" for="showNPCs">
            <i class="fas fa-user"></i> NPCs & Traders
          </label>
        </div>
        <hr>
        <button class="btn btn-sm btn-secondary w-100 mb-2" id="resetView">
          <i class="fas fa-sync-alt"></i> Reset View
        </button>
        <button class="btn btn-sm btn-warning w-100 mb-2" id="exportMarkers">
          <i class="fas fa-download"></i> Save Markers to File
        </button>
        <button class="btn btn-sm btn-danger w-100" id="deleteAllMarkers">
          <i class="fas fa-trash-alt"></i> Delete All Markers
        </button>
      </div>
    </div>

    <div class="col-lg-9">
      <div class="map-container">
        <div id="interactive-map"></div>
        <div class="map-loading" id="mapLoading">
          <i class="fas fa-spinner fa-spin"></i> Loading map...
        </div>
        <!-- Undo/Redo Controls -->
        <div class="map-undo-redo-controls">
          <button class="map-control-btn" id="undoBtn" title="Undo (Ctrl+Z)" disabled>
            <i class="fas fa-undo"></i>
          </button>
          <button class="map-control-btn" id="redoBtn" title="Redo (Ctrl+Y)" disabled>
            <i class="fas fa-redo"></i>
          </button>
        </div>
        <!-- Clear All Markers Button -->
        <div class="map-clear-all-btn-container">
          <button class="map-control-btn map-clear-all-btn" id="clearAllMapMarkersBtn" title="Clear All Markers">
            <i class="fas fa-eraser"></i>
          </button>
        </div>
        <!-- Minimap -->
        <div class="minimap-container" id="minimapContainer">
          <div class="minimap-header">Overview</div>
          <div id="minimap"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Context Menu -->
<div class="map-context-menu" id="mapContextMenu">
  <button class="context-menu-item" data-action="add-marker">
    <i class="fas fa-map-pin"></i> Add Marker
  </button>
  <button class="context-menu-item" data-action="add-to-group" id="addToGroupOption" style="display: none;">
    <i class="fas fa-plus-circle"></i> Add Marker to Group
  </button>
  <button class="context-menu-item danger" data-action="remove-marker" id="removeMarkerOption" style="display: none;">
    <i class="fas fa-trash-alt"></i> Remove This Marker
  </button>
  <button class="context-menu-item danger" data-action="remove-from-group" id="removeFromGroupOption" style="display: none;">
    <i class="fas fa-minus-circle"></i> Remove Marker from Group
  </button>
  <button class="context-menu-item danger" data-action="delete-group" id="deleteGroupOption" style="display: none;">
    <i class="fas fa-trash"></i> Delete Marker Group
  </button>
  <button class="context-menu-item" data-action="ungroup" id="ungroupOption" style="display: none;">
    <i class="fas fa-object-ungroup"></i> Ungroup Markers
  </button>
  <div class="context-menu-separator"></div>
  <button class="context-menu-item" data-action="add-home">
    <i class="fas fa-home"></i> Add Home Base
  </button>
  <button class="context-menu-item" data-action="add-friend">
    <i class="fas fa-user-friends"></i> Add Friend Base
  </button>
  <div class="context-menu-separator"></div>
  <button class="context-menu-item" data-action="directions">
    <i class="fas fa-route"></i> Get Directions
  </button>
  <div class="context-menu-separator"></div>
  <button class="context-menu-item danger" data-action="remove-this-home" id="removeThisHomeOption" style="display: none;">
    <i class="fas fa-trash-alt"></i> Delete This Home
  </button>
  <button class="context-menu-item danger" data-action="remove-home">
    <i class="fas fa-trash"></i> Remove Home Markers
  </button>
</div>

<!-- Friend Base Name Modal -->
<div class="custom-modal" id="friendBaseModal">
  <div class="custom-modal-content">
    <h5 class="custom-modal-header">
      <i class="fas fa-user-friends"></i> Name Friend's Base
    </h5>
    <div class="custom-modal-body">
      <input type="text" id="friendBaseName" placeholder="Enter friend's name..." maxlength="30">
    </div>
    <div class="custom-modal-footer">
      <button class="modal-btn modal-btn-secondary" id="friendBaseCancel">Cancel</button>
      <button class="modal-btn modal-btn-primary" id="friendBaseConfirm">Add Marker</button>
    </div>
  </div>
</div>

<!-- Marker Type Selection Modal -->
<div class="custom-modal" id="markerTypeModal">
  <div class="custom-modal-content marker-type-modal">
    <h5 class="custom-modal-header">
      <i class="fas fa-map-pin"></i> Select Marker Type
    </h5>
    <div class="custom-modal-body">
      <div class="marker-type-grid" id="markerTypeGrid">
        <!-- Complex markers with category selection -->
        <button class="marker-type-btn" data-category="items" data-icon="fa-box" data-type="complex">
          <i class="fas fa-box"></i>
          <span>Items</span>
        </button>
        <button class="marker-type-btn" data-category="items" data-icon="fa-utensils" data-type="complex">
          <i class="fas fa-utensils"></i>
          <span>Food</span>
        </button>
        <button class="marker-type-btn" data-category="npcs" data-icon="fa-users" data-type="complex">
          <i class="fas fa-users"></i>
          <span>NPCs & Enemies</span>
        </button>
        <button class="marker-type-btn" data-category="items" data-icon="fa-hammer" data-type="complex">
          <i class="fas fa-hammer"></i>
          <span>Base & Building</span>
        </button>

        <!-- Simple location markers -->
        <button class="marker-type-btn" data-category="locations" data-icon="fa-robot" data-type="simple">
          <i class="fas fa-robot"></i>
          <span>Robot Station</span>
        </button>
        <button class="marker-type-btn" data-category="items" data-icon="fa-battery-half" data-type="simple">
          <i class="fas fa-battery-half"></i>
          <span>Charging</span>
        </button>
        <button class="marker-type-btn" data-category="locations" data-icon="fa-plug" data-type="simple">
          <i class="fas fa-plug"></i>
          <span>Outlet</span>
        </button>
        <button class="marker-type-btn" data-category="locations" data-icon="fa-door-open" data-type="simple">
          <i class="fas fa-door-open"></i>
          <span>Door</span>
        </button>
        <button class="marker-type-btn" data-category="locations" data-icon="fa-lock" data-type="simple">
          <i class="fas fa-lock"></i>
          <span>Doors (locked)</span>
        </button>
        <button class="marker-type-btn" data-category="locations" data-icon="fa-level-up-alt" data-type="simple">
          <i class="fas fa-level-up-alt"></i>
          <span>Up Floor</span>
        </button>
        <button class="marker-type-btn" data-category="locations" data-icon="fa-level-down-alt" data-type="simple">
          <i class="fas fa-level-down-alt"></i>
          <span>Down Floor</span>
        </button>
        <button class="marker-type-btn" data-category="locations" data-icon="fa-font" data-type="simple">
          <i class="fas fa-font"></i>
          <span>Text</span>
        </button>
        <button class="marker-type-btn" data-category="locations" data-icon="fa-sticky-note" data-type="simple">
          <i class="fas fa-sticky-note"></i>
          <span>Note</span>
        </button>
        <button class="marker-type-btn" data-category="npcs" data-icon="fa-shopping-cart" data-type="simple">
          <i class="fas fa-shopping-cart"></i>
          <span>Vending Machines</span>
        </button>
        <button class="marker-type-btn" data-category="locations" data-icon="fa-map-marker-alt" data-type="simple">
          <i class="fas fa-map-marker-alt"></i>
          <span>Locations</span>
        </button>
      </div>
    </div>
    <div class="custom-modal-footer">
      <button class="modal-btn modal-btn-secondary" id="markerTypeCancel">Cancel</button>
    </div>
  </div>
</div>

<!-- Preset Selection Modal (Searchable Items/Enemies) -->
<div class="custom-modal" id="presetSelectionModal">
  <div class="custom-modal-content preset-selection-modal">
    <h5 class="custom-modal-header" id="presetSelectionHeader">
      <i class="fas fa-search"></i> Select Item
    </h5>
    <div class="custom-modal-body">
      <!-- Search Bar -->
      <div class="preset-search-container mb-3">
        <input type="text" id="presetSearch" class="form-control search-input" placeholder="Search...">
        <i class="fas fa-search search-icon"></i>
      </div>

      <!-- Preset Grid -->
      <div class="preset-grid" id="presetGrid">
        <div class="preset-loading">
          <i class="fas fa-spinner fa-spin"></i> Loading...
        </div>
      </div>
    </div>
    <div class="custom-modal-footer">
      <button class="modal-btn modal-btn-secondary" id="presetSelectionBack">Back</button>
      <button class="modal-btn modal-btn-secondary" id="presetSelectionCustom">Custom Marker</button>
    </div>
  </div>
</div>

<!-- Marker Details Modal -->
<div class="custom-modal" id="markerDetailsModal">
  <div class="custom-modal-content">
    <h5 class="custom-modal-header" id="markerDetailsHeader">
      <i class="fas fa-map-pin"></i> Add Marker
    </h5>
    <div class="custom-modal-body">
      <div class="mb-3">
        <label class="form-label">Title</label>
        <input type="text" id="markerTitle" class="form-control" placeholder="Enter marker title..." maxlength="50">
      </div>
      <div class="mb-3">
        <label class="form-label">Description</label>
        <textarea id="markerDescription" class="form-control" rows="3" placeholder="Enter marker description..." maxlength="200"></textarea>
      </div>
    </div>
    <div class="custom-modal-footer">
      <button class="modal-btn modal-btn-secondary" id="markerDetailsBack">Back</button>
      <button class="modal-btn modal-btn-primary" id="markerDetailsConfirm">Add Marker</button>
    </div>
  </div>
</div>

<!-- Category Selection Modal -->
<div class="custom-modal" id="categorySelectionModal">
  <div class="custom-modal-content category-selection-modal">
    <h5 class="custom-modal-header">
      <i class="fas fa-th-large"></i> Select Items for Marker
    </h5>
    <div class="custom-modal-body">
      <!-- Optional Marker Name -->
      <div class="mb-3">
        <label class="form-label">Marker Name (Optional)</label>
        <input type="text" id="categoryMarkerName" class="form-control" placeholder="Enter custom marker name...">
      </div>

      <!-- Search Bar -->
      <div class="preset-search-container mb-3">
        <input type="text" id="categorySearch" class="form-control search-input" placeholder="Search items...">
        <i class="fas fa-search search-icon"></i>
      </div>

      <!-- Category Tabs -->
      <div class="category-tabs mb-3">
        <button class="category-tab active" data-category="Base and Building">Base & Building</button>
        <button class="category-tab" data-category="Food">Food</button>
        <button class="category-tab" data-category="People and Enemies">People & Enemies</button>
        <button class="category-tab" data-category="Utility and Travel">Utility & Travel</button>
        <button class="category-tab" data-category="Weapons and Gear">Weapons & Gear</button>
        <button class="category-tab" data-category="Resources">Resources</button>
      </div>

      <!-- Subcategory Tabs -->
      <div class="subcategory-tabs mb-3" id="subcategoryTabs">
        <!-- Dynamically populated based on selected category -->
      </div>

      <!-- Item List with Checkboxes -->
      <div class="category-items-container">
        <div class="category-items-grid" id="categoryItemsGrid">
          <!-- Dynamically populated items -->
        </div>
      </div>
    </div>
    <div class="custom-modal-footer">
      <button class="modal-btn modal-btn-secondary" id="categorySelectionCancel">Cancel</button>
      <button class="modal-btn modal-btn-primary" id="categorySelectionOk">OK</button>
    </div>
  </div>
</div>

<!-- Item Info Modal (Draggable/Resizable) -->
<div class="item-info-modal" id="itemInfoModal">
  <div class="item-info-header">
    <button class="item-info-pin" id="itemInfoPin" title="Pin modal">
      <i class="fas fa-thumbtack"></i>
    </button>
    <div class="item-info-drag-handle" id="itemInfoDragHandle">
      <i class="fas fa-grip-horizontal"></i>
    </div>
    <button class="item-info-close" id="itemInfoClose">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div class="item-info-content">
    <div class="item-info-body">
      <div class="item-info-left">
        <h4 class="item-info-title" id="itemInfoTitle">Item Name</h4>
        <a href="#" class="item-info-wiki-link" id="itemInfoWikiLink" target="_blank" rel="noopener noreferrer">
          <i class="fas fa-external-link-alt"></i> View on Wiki
        </a>

        <div class="item-info-section" id="itemInfoCategory">
          <h6>Category</h6>
          <p>-</p>
        </div>

        <div class="item-info-section" id="itemInfoLocation">
          <h6>Location</h6>
          <p>-</p>
        </div>

        <div class="item-info-section" id="itemInfoHarvestable">
          <h6>Harvestable Drops</h6>
          <ul></ul>
        </div>

        <div class="item-info-section" id="itemInfoDrops">
          <h6>Drops</h6>
          <ul></ul>
        </div>

        <div class="item-info-section" id="itemInfoScrap">
          <h6>Scrap Result</h6>
          <ul></ul>
        </div>

        <div class="item-info-section" id="itemInfoRecipe">
          <h6>Recipe</h6>
          <ul></ul>
        </div>

        <div class="item-info-section" id="itemInfoButchering">
          <h6>Butchering</h6>
          <ul></ul>
        </div>

        <div class="item-info-section" id="itemInfoTrades">
          <h6>Trades</h6>
          <ul></ul>
        </div>

        <div class="item-info-section" id="itemInfoDescription">
          <h6>Description</h6>
          <p>-</p>
        </div>

        <div class="item-info-section">
          <h6>Notes</h6>
          <textarea id="itemInfoNotes" class="item-info-notes" placeholder="Add your notes here..."></textarea>
        </div>
      </div>
      <div class="item-info-right">
        <div class="item-info-image-container">
          <img id="itemInfoImage" class="item-info-image" src="" alt="Item image">
          <button class="item-info-add-image" id="itemInfoAddImage">
            <i class="fas fa-plus"></i> Add Image
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="item-info-resize-handle" id="itemInfoResizeHandle">
    <i class="fas fa-grip-lines-diagonal"></i>
  </div>
</div>

<!-- Marker Group View Modal -->
<div class="custom-modal" id="markerGroupModal">
  <div class="custom-modal-content marker-group-modal">
    <h5 class="custom-modal-header">
      <i class="fas fa-layer-group"></i> Marker Group
    </h5>
    <div class="custom-modal-body">
      <div class="marker-group-container">
        <div class="marker-group-tabs" id="markerGroupTabs">
          <!-- Tabs will be dynamically populated -->
        </div>
        <div class="marker-group-content" id="markerGroupContent">
          <!-- Content will be dynamically populated -->
        </div>
      </div>
    </div>
    <div class="custom-modal-footer">
      <button class="modal-btn modal-btn-secondary" id="markerGroupClose">Close</button>
    </div>
  </div>
</div>

<!-- Remove Markers from Group Modal -->
<div class="custom-modal" id="removeMarkersModal">
  <div class="custom-modal-content">
    <h5 class="custom-modal-header">
      <i class="fas fa-minus-circle"></i> Remove Markers from Group
    </h5>
    <div class="custom-modal-body">
      <p style="margin-bottom: 1rem; color: rgba(255,255,255,0.8);">Select markers to remove:</p>
      <div class="remove-markers-list" id="removeMarkersList">
        <!-- Checkboxes will be dynamically populated -->
      </div>
    </div>
    <div class="custom-modal-footer">
      <button class="modal-btn modal-btn-secondary" id="removeMarkersCancel">Cancel</button>
      <button class="modal-btn modal-btn-primary" id="removeMarkersConfirm">Remove Selected</button>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Global Confirmation Modal -->
<div class="confirm-modal" id="confirmModal">
  <div class="confirm-modal-content">
    <div class="confirm-modal-header">
      <i class="fas fa-exclamation-triangle confirm-modal-icon" id="confirmModalIcon"></i>
      <h5 class="confirm-modal-title" id="confirmModalTitle">Confirm Action</h5>
    </div>
    <div class="confirm-modal-body" id="confirmModalBody">
      Are you sure you want to proceed?
    </div>
    <div class="confirm-modal-footer">
      <button class="modal-btn modal-btn-secondary" id="confirmModalCancel">Cancel</button>
      <button class="modal-btn modal-btn-primary" id="confirmModalConfirm">Confirm</button>
    </div>
  </div>
</div>
